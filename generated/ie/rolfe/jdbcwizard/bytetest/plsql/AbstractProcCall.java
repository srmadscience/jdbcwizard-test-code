package ie.rolfe.jdbcwizard.bytetest.plsql;


import java.sql.*; 
import com.orindasoft.pub.LogInterface; 
import com.orindasoft.pub.StatsInterface; 
import com.orindasoft.pub.OracleResourceUser; 
import com.orindasoft.pub.CallableStatementParameters;
import com.orindasoft.pub.CSException; 

/** 
* Abstract procedure call class used by classes generated by JDBCWizard
* Generated by JDBCWizard 6.0.3145 build 3145 at 2025/11/14 10:21:20.53 EST
*/ 
public abstract class AbstractProcCall implements OracleResourceUser, StatsInterface 
{ 
  public static final int THIS_USERS_OBJECT = 0; 
  
  public static final int OTHER_USERS_OBJECT = 1; 
  
  public static final int THIS_USERS_SYNONYM = 2; 
  
  public static final int PUBLIC_SYNONYM = 3; 
  
  public Connection theConnection = null; 
  
  public com.orindasoft.pub.LogInterface theLog = null; 
  
  public CallableStatement theCallableStatement = null; 
  
  CallableStatementParameters theParameters = null; 
  
  private static final int theBuildNumber =  3145;
  
  long parseCount = 0;                          
                                                
  long parseTimeMilliseconds = 0;                          
                                                
  long executionCount = 0;                               
                                                       
  long executionTimeMilliseconds = 0;                               
                                                       
  long retrieveTimeMilliseconds = 0;                               
                                                       
  long releaseCount = 0;                              
  
  long errorCount = 0;                              
  
  long statsEventTimer = 0;                              
  
  public AbstractProcCall(Connection theConnection, LogInterface theLog) 
    { 
    this.theConnection = theConnection; 
    this.theLog = theLog; 
    theParameters = new CallableStatementParameters(getProcCallStatement(),theLog); 
    } 
   
  public AbstractProcCall(LogInterface theLog)      
    {                                                 
    this.theLog = theLog;                             
    theParameters = new CallableStatementParameters(getProcCallStatement(),theLog); 
    }                                                  
   
  public void setConnection(Connection theConnection)  
    {                                               
    this.theConnection = theConnection;          
    }                                           
   
  public abstract String getProcCallStatement(); 
  
  protected CallableStatement prepareCallableStatement() throws CSException     
    {                                                                   
    CallableStatement newCallableStatement;                                      
                                                                     
    startStatsTimer();     
    try                                                              
      {                                                                
      theLog.debug("AbstractProcCall - Starting to parse statement");
      newCallableStatement = theConnection.prepareCall(getProcCallStatement());    
      theLog.debug("AbstractProcCall - Finished parsing statement");
      }                                                                  
    catch (java.sql.SQLException e)                                    
      {    
      incErrorCount();
      theLog.error("AbstractProcCall: Prepare Statement failed with " + e.toString());
      throw (new CSException("Unable to parse statement: " + e.toString()));   
      }       
              
    incParseCount();   
                      
    return(newCallableStatement);  
                        
    }                      
                         
  protected void createParams(String sqlString)
    {
    theParameters = new CallableStatementParameters(sqlString,theLog);
    }                                                                   
   
  protected abstract void bindParams() throws CSException; 
   
  protected abstract void getStatementResults() throws CSException; 
   
  public void connectAndPrepare() throws CSException
    {                                                                   
    if (theConnection == null) 
      {                               
      throw (new CSException("Not Connected -  Callable Statement can not be executed"));  
      }                                    
                                          
    if (theCallableStatement == null)            
      {                                      
      theCallableStatement = prepareCallableStatement(); 
       
      com.orindasoft.pub.StatementParameters2.checkBuild(theBuildNumber);
      }     
    }                                    
  public void executeProc() throws CSException
    {                                                                   
           
    connectAndPrepare();
           
    try     
      {       
      bindParams();       
      issueCall();        
      getStatementResults(); 
      }                     
    catch (CSException e)  
      {                 
      incErrorCount();   
      theLog.warning("First attempt at execution failed: " + e.toString()); 
      theCallableStatement = prepareCallableStatement();   
      bindParams();                 
      issueCall();                  
      getStatementResults();        
      }                            
    catch (Error e)  
      {                 
      incErrorCount();   
      theCallableStatement = null;   
      theLog.syserror("Error thrown while trying to execute statement:" + e.getClass().getName() + ":" + e.getMessage());
      throw(e);                    
      }                            
                                 
    }                       
  
  private void issueCall() throws CSException  
    {                                         
    try                                      
      {                                        
      startStatsTimer();               
      theLog.debug("AbstractProcCall - About to execute statement");
      theCallableStatement.execute();          
      theLog.debug("AbstractProcCall - Finished executing statement");
      incExecutionCount();     
      }                                        
    catch (SQLException e)                   
      {                                         
      throw (new CSException(e.toString()));    
      }                                          
    }                                                                   
   
   
   
  public boolean releaseResources() 
    { 
    boolean returnCode = true; 
    
    theLog.debug("AbstractProcCall - Attempting to release connection");
    
    try 
      { 
      
      if (theCallableStatement != null)
        { 
        theCallableStatement.close(); 
        } 
      } 
    catch (SQLException e) 
      { 
      incErrorCount();
      theLog.warning(e.toString()); 
      returnCode = false; 
      } 
    
    theConnection = null; 
    theCallableStatement = null; 
    incReleaseCount(); 
    theLog.debug("AbstractProcCall- Finished releasing connection");
    
    return(returnCode); 
    } 
  
  public boolean hasResources() 
    { 
    if (theConnection == null) 
      { 
      return (false); 
      } 
    
    return(true); 
    } 
   
  public void resetStatsCounters()      
    {                                  
    parseCount = 0;               
    executionCount = 0;           
    parseTimeMilliseconds = 0;               
    executionTimeMilliseconds = 0;           
    retrieveTimeMilliseconds = 0;           
    releaseCount = 0;       
    errorCount = 0;       
    }                            
                             
  public long getParses()      
    {                               
    return (parseCount);           
    }                             
  
  public long getParseTime()      
    {                               
    return (parseTimeMilliseconds);           
    }                             
  
  public long getExecutions()     
    {                               
    return (executionCount);       
    }                                  
   
  public long getExecutionTime()     
    {                               
    return (executionTimeMilliseconds);       
    }                                  
   
  public long getRetrievalTime()     
    {                               
    return (retrieveTimeMilliseconds);       
    }                                  
   
  public long getReleases()             
    {                                
    return (releaseCount);                
    }                              
   
  public long getErrors()             
    {                                
    return (errorCount);                
    }                              
  
  protected void startStatsTimer()      
    {                                    
    statsEventTimer = System.currentTimeMillis();
    }                         
   
  public void incParseCount()      
    {                                    
    parseTimeMilliseconds = parseTimeMilliseconds + (System.currentTimeMillis() - statsEventTimer);
    statsEventTimer=0;
    
    if (parseCount < Long.MAX_VALUE)  
      {                               
      parseCount++;                    
      }                                
    else 
      {     
      theLog.syserror("parse counter is greater than " + parseCount); 
      }                            
    }                         
   
  public void incExecutionCount()   
    {                               
    executionTimeMilliseconds = executionTimeMilliseconds + (System.currentTimeMillis() - statsEventTimer);
    statsEventTimer=0;
    
    if (executionCount < Long.MAX_VALUE)  
      {                                   
      executionCount++;                   
      }                                  
    else  
      {     
      theLog.syserror("execution counter is greater than " + executionCount);   
      }                       
    }                                
   
  public void incRetrieveTime()   
    {                               
    retrieveTimeMilliseconds = retrieveTimeMilliseconds + (System.currentTimeMillis() - statsEventTimer);
    statsEventTimer=0;
    }                                
   
  public void incReleaseCount()     
    {                                  
    if (releaseCount < Long.MAX_VALUE)   
      {                                   
      releaseCount++;                  
      }                                    
    else  
      {      
      theLog.syserror("release counter is greater than " + releaseCount);   
      }                          
    } 
   
  public void incErrorCount()     
    {                                  
    if (errorCount < Long.MAX_VALUE)   
      {                                   
      errorCount++;                  
      }                                    
    else  
      {      
      theLog.syserror("error counter is greater than " + releaseCount);   
      }                          
    } 
  } // Generated by JDBCWizard 6.0.3145  
